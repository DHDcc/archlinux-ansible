- name: Check if the CPU supports virtualization
  shell: "grep -Ec '(vmx|svm)' /proc/cpuinfo"
  register: cpu_virtualization_support
  changed_when: false
  become: false

- name: Warn if virtualization is not supported
  ansible.builtin.warn:
    msg: |
      Virtualization not enabled virtualization or not supported. 
      Go to bios settings and enable VT-x (Virtualization Technology Extension) for Intel processor 
      and AMD-V for AMD processor
    when: cpu_virtualization_support.stdout | int == 0

- name: Remove conflicting packages
  community.general.pacman:
    name: 
      - iptables
      - iptables-nft
    state: absent
    force: true
  when: cpu_virtualization_support.stdout | int > 0

- name: Install qemu/virtmanager
  community.general.pacman:
    name: "{{ hypervisor.packages }}"
    state: present
  when: cpu_virtualization_support.stdout | int > 0

- name: Enable/start service
  ansible.builtin.systemd_service:
    name: "{{ hypervisor.service }}"
    state: started
    enabled: yes
  when: cpu_virtualization_support.stdout | int > 0
   
- name: Start and autostart default network
  community.libvirt.virt_net:
    name: default
    state: active
    autostart: true
  when: cpu_virtualization_support.stdout | int > 0

- name: Add user to the libvirt and kvm group
  ansible.builtin.user:
    name: "{{ user.name }}"
    groups: "{{ hypervisor.groups }}"
    append: yes
  notify: restart libvirtd
  when: cpu_virtualization_support.stdout | int > 0

- name: Change firewall backend for libvirt
  ansible.builtin.lineinfile:
    path: "/etc/libvirt/network.conf"
    search_string: "firewall_backend ="
    line: 'firewall_backend = "iptables"'
  when: cpu_virtualization_support.stdout | int > 0
